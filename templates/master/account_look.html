<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アカウント情報</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // メールアドレスの重複チェック
        function checkDuplicateEmail(row) {
            const mailInput = row.querySelector('td:nth-child(3) input'); // メールアドレスの入力欄
            const mailAddress = mailInput.value;
            let isDuplicate = false;

            document.querySelectorAll('tr').forEach(r => {
                const emailCell = r.querySelector('td:nth-child(3)');
                if (emailCell && emailCell.innerText === mailAddress && r !== row) {
                    isDuplicate = true;
                }
            });

            const warningMessage = row.querySelector('.email-warning');
            if (isDuplicate) {
                if (!warningMessage) {
                    const warning = document.createElement('div');
                    warning.classList.add('email-warning');
                    warning.style.color = 'red';
                    warning.innerText = 'このメールアドレスはすでに使用されています。';
                    mailInput.parentElement.appendChild(warning);
                }
                row.querySelector('.save-button').disabled = true; // 保存ボタンを無効化
            } else {
                if (warningMessage) {
                    warningMessage.remove(); // 警告メッセージを削除
                }
                row.querySelector('.save-button').disabled = false; // 保存ボタンを有効化
            }
        }

        function editRow(row) {
            const cells = row.getElementsByTagName('td');
            for (let i = 1; i < cells.length - 1; i++) { // アカウントIDを除外
                const currentText = cells[i].innerText;
                cells[i].innerHTML = `<input type="text" value="${currentText}">`;
            }
            row.querySelector('.edit-button').style.display = 'none'; // 編集ボタン非表示
            row.querySelector('.save-button').style.display = 'inline'; // 保存ボタン表示
            row.querySelector('.cancel-button').style.display = 'inline'; // キャンセルボタン表示
            row.querySelector('.delete-button').style.display = 'none'; // 削除ボタン非表示

            // メールアドレスの変更を監視して重複チェック
            row.querySelector('td:nth-child(3) input').addEventListener('input', () => checkDuplicateEmail(row));
        }

        function cancelEdit(row) {
            const cells = row.getElementsByTagName('td');
            for (let i = 1; i < cells.length - 1; i++) { // アカウントIDを除外
                const originalText = cells[i].getAttribute('data-original'); // 元の値を取得
                cells[i].innerText = originalText; // 元の値に戻す
            }
            row.querySelector('.edit-button').style.display = 'inline'; // 編集ボタン表示
            row.querySelector('.save-button').style.display = 'none'; // 保存ボタン非表示
            row.querySelector('.cancel-button').style.display = 'none'; // キャンセルボタン非表示
            row.querySelector('.delete-button').style.display = 'inline'; // 削除ボタン表示
        }

        async function saveRow(row) {
            const cells = row.getElementsByTagName('td');
            const accountId = cells[0].innerText; // アカウントIDを取得
            const accountName = cells[1].querySelector('input').value;
            const mailAddress = cells[2].querySelector('input').value;
            const password = cells[3].querySelector('input').value;

            // メールアドレス重複チェック
            const warningMessage = row.querySelector('.email-warning');
            if (warningMessage) {
                return; // 重複があれば保存しない
            }

            // サーバーにデータを送信
            const response = await fetch(`/edit_account/${accountId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    account_name: accountName,
                    mail_address: mailAddress,
                    password: password
                })
            });

            if (response.ok) {
                // サーバーからの応答を処理
                for (let i = 1; i < cells.length - 1; i++) {
                    cells[i].innerText = cells[i].querySelector('input').value; // 入力値をセルに設定
                    cells[i].setAttribute('data-original', cells[i].innerText); // 元の値を保存
                }
                row.querySelector('.edit-button').style.display = 'inline'; // 編集ボタン表示
                row.querySelector('.save-button').style.display = 'none'; // 保存ボタン非表示
                row.querySelector('.cancel-button').style.display = 'none'; // キャンセルボタン非表示
                row.querySelector('.delete-button').style.display = 'inline'; // 削除ボタン表示
            } else {
                alert('更新に失敗しました。');
            }
        }
    </script>
</head>
<body>
    <h1>アカウント情報</h1>
    <table>
        <tr>
            <th>アカウントID</th>
            <th>アカウント名</th>
            <th>メールアドレス</th>
            <th>パスワード</th>
            <th>操作</th>
        </tr>
        {% for account in accounts %}
        <tr>
            <td>{{ account[0] }}</td>  <!-- ACCOUNT_ID (編集不可) -->
            <td data-original="{{ account[1] }}">{{ account[1] }}</td>  <!-- ACCOUNT_NAME -->
            <td data-original="{{ account[2] }}">{{ account[2] }}</td>  <!-- MAIL -->
            <td data-original="{{ account[3] }}">{{ account[3] }}</td>  <!-- PASS -->
            <td>
                <button class="edit-button" type="button" onclick="editRow(this.parentElement.parentElement)">編集</button>
                <button class="save-button" type="button" style="display:none;" onclick="saveRow(this.parentElement.parentElement)">保存</button>
                <button class="cancel-button" type="button" style="display:none;" onclick="cancelEdit(this.parentElement.parentElement)">キャンセル</button>
                <button class="delete-button" type="button" onclick="showDeleteConfirmation(this.parentElement.parentElement)">削除</button>
                <span class="delete-confirm" style="display:none;">
                    <button type="button" onclick="deleteAccount(this.closest('tr'))">はい</button>
                    <button type="button" onclick="cancelDelete(this.parentElement.parentElement)">いいえ</button>
                </span>
            </td>
        </tr>
        {% endfor %}
    </table>
    <a href="{{ url_for('mainmenu') }}">メインメニュー</a>
    <a href="{{ url_for('logout') }}">ログアウト</a>
</body>
</html>
