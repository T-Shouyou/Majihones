{% extends 'base.html' %}

{% block title %}ごはん広場{% endblock %}

{% block content %}
    <link rel="stylesheet" href="style.css">

    <br><br>
    <h1 class="txt-center">ごはん広場</h1>

    <h2 class="txt-center">投稿された内容</h2>

    <div class="posts">
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.post_id }}">
            <hr>
            <p class="post-txt">
                <strong>投稿者名:</strong> {{ post.account_name }}
                {% if account_id == 1 or post.account_id == account_id %}
                <button onclick="toggleEditMode(this)" class="edit-button">編集</button>
                <button class="cancel-button" style="display:none;" onclick="cancelEdit(this)">キャンセル</button>
                {% endif %}
            </p>
            <hr>
            <div class="post-content">
                {% if post.photo %}
                <img src="{{ url_for('static', filename='hiroba_img/' + post.photo) }}" alt="投稿画像" class="post-img">
                {% endif %}
                <p class="post-txt" data-original="{{ post.sentence }}">{{ post.sentence }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="fixed-button">
        <button onclick="location.href='{{ url_for('mainmenu') }}';" class="main-button">メイン<br>メニュー</button>
        <button onclick="location.href='{{ url_for('post_gohan') }}';" class="main-button">ごはん投稿</button>
    </div>

    <script>
        let currentEditingPost = null;

        async function toggleEditMode(button) {
            const postElement = button.closest('.post');
            const sentenceElement = postElement.querySelector('.post-txt[data-original]');
            const originalText = sentenceElement.getAttribute('data-original');
            const editButton = postElement.querySelector('.edit-button');
            const cancelButton = postElement.querySelector('.cancel-button');
            const postId = postElement.getAttribute('data-post-id');

            if (editButton.textContent === "編集") {
                sentenceElement.innerHTML = `<textarea>${originalText}</textarea>`;
                editButton.textContent = "完了";
                cancelButton.style.display = 'inline';
                currentEditingPost = postElement;
            } else if (editButton.textContent === "完了") {
                const updatedSentence = sentenceElement.querySelector('textarea').value;

                const response = await fetch(`/hiroba/edit_post/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sentence: updatedSentence })
                });

                if (response.ok) {
                    sentenceElement.innerHTML = updatedSentence;
                    sentenceElement.setAttribute('data-original', updatedSentence);
                    editButton.textContent = "編集";
                    cancelButton.style.display = 'none';
                    currentEditingPost = null;
                }
            }
        }

        function cancelEdit(button) {
            const postElement = button.closest('.post');
            const sentenceElement = postElement.querySelector('.post-txt[data-original]');
            const originalText = sentenceElement.getAttribute('data-original');
            const editButton = postElement.querySelector('.edit-button');
            const cancelButton = postElement.querySelector('.cancel-button');

            // 編集内容をキャンセルし元に戻す
            sentenceElement.innerHTML = originalText;  // 元のテキストに戻す
            editButton.textContent = "編集";  // 編集ボタンのテキストを変更
            cancelButton.style.display = 'none';  // キャンセルボタンを非表示
        }
    </script>
{% endblock %}
